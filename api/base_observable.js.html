<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>base/observable.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="QueryString.html">QueryString</a><ul class='methods'><li data-type='method'><a href="QueryString.html#get">get</a></li><li data-type='method'><a href="QueryString.html#set">set</a></li><li data-type='method'><a href="QueryString.html#toJSON">toJSON</a></li></ul></li><li><a href="Router.html">Router</a><ul class='methods'></ul></li><li><a href="veronica.Application.html">Application</a><ul class='methods'><li data-type='method'><a href="veronica.Application.html#busy">busy</a></li><li data-type='method'><a href="veronica.Application.html#start">start</a></li><li data-type='method'><a href="veronica.Application.html#stop">stop</a></li><li data-type='method'><a href="veronica.Application.html#use">use</a></li></ul></li><li><a href="veronica.AppPart.html">AppPart</a><ul class='methods'><li data-type='method'><a href="veronica.AppPart.html#app">app</a></li><li data-type='method'><a href="veronica.AppPart.html#loader">loader</a></li><li data-type='method'><a href="veronica.AppPart.html#logger">logger</a></li></ul></li><li><a href="veronica.AppProvider.html">AppProvider</a><ul class='methods'><li data-type='method'><a href="veronica.AppProvider.html#add">add</a></li><li data-type='method'><a href="veronica.AppProvider.html#get">get</a></li><li data-type='method'><a href="veronica.AppProvider.html#has">has</a></li><li data-type='method'><a href="veronica.AppProvider.html#remove">remove</a></li><li data-type='method'><a href="veronica.AppProvider.html#setDefault">setDefault</a></li></ul></li><li><a href="veronica.AppRouter.html">AppRouter</a><ul class='methods'></ul></li><li><a href="veronica.BaseClass.html">BaseClass</a><ul class='methods'><li data-type='method'><a href="veronica.BaseClass.html#.members">members</a></li><li data-type='method'><a href="veronica.BaseClass.html#.methods">methods</a></li><li data-type='method'><a href="veronica.BaseClass.html#.statics">statics</a></li><li data-type='method'><a href="veronica.BaseClass.html#implement">implement</a></li></ul></li><li><a href="veronica.Component.html">Component</a><ul class='methods'><li data-type='method'><a href="veronica.Component.html#$">$</a></li><li data-type='method'><a href="veronica.Component.html#active">active</a></li><li data-type='method'><a href="veronica.Component.html#children">children</a></li><li data-type='method'><a href="veronica.Component.html#create">create</a></li><li data-type='method'><a href="veronica.Component.html#createPart">createPart</a></li><li data-type='method'><a href="veronica.Component.html#createProvider">createProvider</a></li><li data-type='method'><a href="veronica.Component.html#destroy">destroy</a></li><li data-type='method'><a href="veronica.Component.html#get">get</a></li><li data-type='method'><a href="veronica.Component.html#hide">hide</a></li><li data-type='method'><a href="veronica.Component.html#listen">listen</a></li><li data-type='method'><a href="veronica.Component.html#listenTo">listenTo</a></li><li data-type='method'><a href="veronica.Component.html#log">log</a></li><li data-type='method'><a href="veronica.Component.html#model">model</a></li><li data-type='method'><a href="veronica.Component.html#parent">parent</a></li><li data-type='method'><a href="veronica.Component.html#parents">parents</a></li><li data-type='method'><a href="veronica.Component.html#parse">parse</a></li><li data-type='method'><a href="veronica.Component.html#part">part</a></li><li data-type='method'><a href="veronica.Component.html#pub">pub</a></li><li data-type='method'><a href="veronica.Component.html#render">render</a></li><li data-type='method'><a href="veronica.Component.html#reset">reset</a></li><li data-type='method'><a href="veronica.Component.html#show">show</a></li><li data-type='method'><a href="veronica.Component.html#startChildren">startChildren</a></li><li data-type='method'><a href="veronica.Component.html#stop">stop</a></li><li data-type='method'><a href="veronica.Component.html#stopChildren">stopChildren</a></li><li data-type='method'><a href="veronica.Component.html#sub">sub</a></li><li data-type='method'><a href="veronica.Component.html#subOnce">subOnce</a></li><li data-type='method'><a href="veronica.Component.html#toJSON">toJSON</a></li><li data-type='method'><a href="veronica.Component.html#ui">ui</a></li><li data-type='method'><a href="veronica.Component.html#unsub">unsub</a></li></ul></li><li><a href="veronica.ComponentDefManager.html">ComponentDefManager</a><ul class='methods'><li data-type='method'><a href="veronica.ComponentDefManager.html#resolve">resolve</a></li></ul></li><li><a href="veronica.ComponentManager.html">ComponentManager</a><ul class='methods'><li data-type='method'><a href="veronica.ComponentManager.html#findDom">findDom</a></li><li data-type='method'><a href="veronica.ComponentManager.html#getByDom">getByDom</a></li><li data-type='method'><a href="veronica.ComponentManager.html#isCurrBatch">isCurrBatch</a></li><li data-type='method'><a href="veronica.ComponentManager.html#register">register</a></li><li data-type='method'><a href="veronica.ComponentManager.html#start">start</a></li><li data-type='method'><a href="veronica.ComponentManager.html#stop">stop</a></li><li data-type='method'><a href="veronica.ComponentManager.html#stopAll">stopAll</a></li><li data-type='method'><a href="veronica.ComponentManager.html#stopByDom">stopByDom</a></li></ul></li><li><a href="veronica.History.html">History</a><ul class='methods'></ul></li><li><a href="veronica.LayoutManager.html">LayoutManager</a><ul class='methods'><li data-type='method'><a href="veronica.LayoutManager.html#change">change</a></li><li data-type='method'><a href="veronica.LayoutManager.html#init">init</a></li></ul></li><li><a href="veronica.Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="veronica.Logger.html#enable">enable</a></li><li data-type='method'><a href="veronica.Logger.html#error">error</a></li><li data-type='method'><a href="veronica.Logger.html#info">info</a></li><li data-type='method'><a href="veronica.Logger.html#log">log</a></li><li data-type='method'><a href="veronica.Logger.html#setName">setName</a></li><li data-type='method'><a href="veronica.Logger.html#time">time</a></li><li data-type='method'><a href="veronica.Logger.html#warn">warn</a></li></ul></li><li><a href="veronica.Observable.html">Observable</a><ul class='methods'><li data-type='method'><a href="veronica.Observable.html#after">after</a></li><li data-type='method'><a href="veronica.Observable.html#before">before</a></li><li data-type='method'><a href="veronica.Observable.html#listenTo">listenTo</a></li><li data-type='method'><a href="veronica.Observable.html#listenToOnce">listenToOnce</a></li><li data-type='method'><a href="veronica.Observable.html#off">off</a></li><li data-type='method'><a href="veronica.Observable.html#on">on</a></li><li data-type='method'><a href="veronica.Observable.html#once">once</a></li><li data-type='method'><a href="veronica.Observable.html#onFirst">onFirst</a></li><li data-type='method'><a href="veronica.Observable.html#stopListen">stopListen</a></li><li data-type='method'><a href="veronica.Observable.html#trigger">trigger</a></li></ul></li><li><a href="veronica.PageManager.html">PageManager</a><ul class='methods'><li data-type='method'><a href="veronica.PageManager.html#change">change</a></li><li data-type='method'><a href="veronica.PageManager.html#getCurrName">getCurrName</a></li><li data-type='method'><a href="veronica.PageManager.html#resolve">resolve</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Lodash.html">Lodash</a><ul class='methods'><li data-type='method'><a href="external-Lodash.html#.decamelize">decamelize</a></li><li data-type='method'><a href="external-Lodash.html#.ensureArray">ensureArray</a></li><li data-type='method'><a href="external-Lodash.html#.getParameterNames">getParameterNames</a></li><li data-type='method'><a href="external-Lodash.html#.mapArrayOrSingle">mapArrayOrSingle</a></li><li data-type='method'><a href="external-Lodash.html#.normalizePath">normalizePath</a></li><li data-type='method'><a href="external-Lodash.html#.safeInvoke">safeInvoke</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Application.html#event:componentsLoaded">componentsLoaded</a></li><li><a href="Application.html#event:layoutChanged">layoutChanged</a></li><li><a href="Application.html#event:layoutChanging">layoutChanging</a></li><li><a href="Application.html#event:pageLoaded">pageLoaded</a></li><li><a href="Application.html#event:pageLoading">pageLoading</a></li><li><a href="Application.html#event:pageNotFound">pageNotFound</a></li><li><a href="veronica.Application.html#event:appStarted">appStarted</a></li></ul><h3>Namespaces</h3><ul><li><a href="veronica.html">veronica</a><ul class='methods'><li data-type='method'><a href="veronica.html#.createClass">createClass</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#resolveLocation">resolveLocation</a></li><li data-type='method'><a href="Module.html#resolvePath">resolvePath</a></li></ul></li><li><a href="TemplateEngine.html">TemplateEngine</a><ul class='methods'><li data-type='method'><a href="TemplateEngine.html#compile">compile</a></li><li data-type='method'><a href="TemplateEngine.html#options">options</a></li></ul></li><li><a href="UIKit.html">UIKit</a><ul class='methods'><li data-type='method'><a href="UIKit.html#create">create</a></li><li data-type='method'><a href="UIKit.html#getInstance">getInstance</a></li><li data-type='method'><a href="UIKit.html#init">init</a></li></ul></li><li><a href="ViewEngine.html">ViewEngine</a><ul class='methods'><li data-type='method'><a href="ViewEngine.html#bind">bind</a></li><li data-type='method'><a href="ViewEngine.html#bindEvents">bindEvents</a></li><li data-type='method'><a href="ViewEngine.html#create">create</a></li><li data-type='method'><a href="ViewEngine.html#get">get</a></li><li data-type='method'><a href="ViewEngine.html#set">set</a></li><li data-type='method'><a href="ViewEngine.html#toJSON">toJSON</a></li><li data-type='method'><a href="ViewEngine.html#unbind">unbind</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">base/observable.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define([
    'lodash',
    './class'
], function (_, createClass) {

    'use strict';

    var eventSplitter = /\s+/;

    function weaveAspect(when, methodName, callback, context) {
        var names = methodName.split(eventSplitter);
        var name, method;

        while (name = names.shift()) {
            method = this[name];
            if (!method) {
                throw new Error('Invalid method name: ' + methodName);
            }

            if (!method.__isAspected) {
                wrapAspectMethod.call(this, name);
            }
            this.on(when + ':' + name, callback, context);
        }

        return this;
    }

    function wrapAspectMethod(methodName) {
        var old = this[methodName];

        this[methodName] = function () {
            var args = Array.prototype.slice.call(arguments);
            var beforeArgs = ['before:' + methodName].concat(args);
            var beforeRet = this.trigger.apply(this, beforeArgs);
            if (beforeRet === false) return;

            var ret = old.apply(this, arguments);
            var afterArgs = ['after:' + methodName, ret].concat(args);
            this.trigger.apply(this, afterArgs);
            return ret;
        };

        this[methodName].__isAspected = true;
    }

    function preventDefault() {
        this._defaultPrevented = true;
    }

    function isDefaultPrevented() {
        return this._defaultPrevented === true;
    }

    var Observable = createClass(/** @lends veronica.Observable# */{
        /**
         * 可观察对象，是所有类型的基类，具有事件和 Aspect 特性
         * @constructs Observable
         * @augments {veronica.BaseClass}
         * @memberOf veronica
         */
        initialize: function () {
            this._events = {};
            this._listenId = _.uniqueId('l');
            this._listeningTo = {};
            this._delayEvents = [];
        },
        /**
         * 添加监听器
         * @param {string} name - 事件名
         * @param {function} callbacks - 回调处理程序
         * @param {boolean} [one=false] - 是否只监听一次
         * @param {Object} [context=this] - 回调上下文
         * @param {string} [insertMethod=push] - 插入事件队列的方法
         * @returns {this}
         */
        on: function (name, callbacks, one, context, insertMethod) {

            var me = this;
            var names = typeof name === 'string' ? [name] : name;
            context || (context = me);
            if (insertMethod == null) {
                insertMethod = 'push';
            }

            var callbacksIsFunction = typeof callbacks === 'function';
            var callback;

            if (callbacks === undefined) {
                for (var key in name) {
                    callback = name[key];
                    me.on(key, callback);
                }
                return this;
            }

            for (var i = 0, len = names.length; i &lt; len; i++) {
                name = names[i];
                callback = callbacksIsFunction ? callbacks : callbacks[name];
                if (!callback) continue;

                if (one) {
                    var original = callback;
                    callback = function () {
                        me.off(name, callback);
                        original.apply(context, arguments);
                    };
                    callback.original = original;
                }

                // 添加到事件池
                me._events[name] = me._events[name] || [];
                var events = me._events[name];
                var handler = {
                    context: context,
                    callback: callback
                };
                events[insertMethod](handler);
            }

            return this;
        },
        /**
         * 添加监听器，仅监听一次
         * @param {string} name - 事件名
         * @param {function} callbacks - 回调处理程序
         * @param {Object} [context=this] - 回调上下文
         * @returns {this}
         */
        once: function (name, callbacks, context) {
            return this.on(name, callbacks, true, context);
        },
        /**
         * 添加监听器，并将监听函数放到事件队列头
         * @param {string} name - 事件名
         * @param {function} callbacks - 回调处理程序
         * @param {boolean} [one=false] - 是否只监听一次
         * @param {Object} [context=this] - 回调上下文
         * @returns {this}
         */
        onFirst: function (name, callbacks, one, context) {
            return this.on(name, callbacks, one, context, 'unshift');
        },
        /**
         * 监听
         * @param {Object} obj - 被监听者
         * @param {string} name - 事件名
         * @param {function} callbacks - 回调处理程序
         * @param {boolean} [one=false] - 是否只监听一次
         * @returns {this}
         */
        listenTo: function (obj, name, callback, one) {
            if (one == null) {
                one = false;
            }

            if (typeof obj === 'string') {
                this._delayEvents.push({
                    name: obj,
                    event: name,
                    callback: callback
                });
                return this;
            }

            var thisId = this._listenId;
            var objId = obj._listenId;
            var listeningTo = this._listeningTo;

            if (!listeningTo[objId]) {
                listeningTo[objId] = {
                    obj: obj,
                    objId: objId,
                    id: thisId,
                    count: 0
                };
            }

            var listening = listeningTo[objId];

            obj.on(name, callback, one, this);

            listening.count++;

            return this;
        },
        /**
         * 监听，仅监听一次
         * @param {Object} obj - 被监听者
         * @param {string} name - 事件名
         * @param {function} callbacks - 回调处理程序
         * @returns {this}
         */
        listenToOnce: function (obj, name, callback) {
            return this.listenTo(obj, name, callback, true);
        },
        /**
         * 移除监听器
         * @param {string} [name] - 事件名
         * @param {function} [callback] - 监听器
         * @param {Object} [context] - 上下文对象
         * @returns {Observable}
         */
        off: function (name, callback, context) {
            var me = this;
            var allEvents = this._events;
            var events = allEvents[name];

            if (name === undefined) {
                // 移除所有 hanlder
                me._events = {};
            } else if (events) {
                if (!callback &amp;&amp; !context) {
                    // 移除某个事件所有 handler
                    me._events[name] = [];
                } else {
                    // 移除单个 handler
                    for (var i = events.length - 1; i >= 0; i--) {
                        var handler = events[i];
                        if (callback &amp;&amp; (callback === handler.callback || callback === handler.original ) ||
                            context &amp;&amp; handler.context === context) {
                            events.splice(i, 1);
                        }
                    }
                }
            }

            return me;
        },
        /**
         * 停止监听
         * @param {Object} [obj] - 被监听者
         * @param {string} [name] - 事件名
         * @param {function} [callback] - 回调处理程序
         */
        stopListen: function (obj, name, callback) {
            var listeningTo = this._listeningTo;
            var ids = obj ? [obj._listenId] : _.keys(listeningTo);

            for (var i = 0; i &lt; ids.length; i++) {
                var listening = listeningTo[ids[i]];

                if (!listening) break;  // 这里用 continue 是否更好？

                listening.obj.off(name, callback, this);
            }
        },
        /**
         * 触发事件
         * @description 将参数用一个对象传递，避免使用多参数或原始类型参数
         * @param {string} name - 事件名
         * @param {Object} [e] - 参数对象
         * @param {Object} [second] - 可能的第二个参数
         * @returns {*} - 调用结果
         */
        trigger: function (name, e, second) {
            if (!this._events) return this;

            var events = this._events[name];
            var me = this;
            if (!events) return;

            var retVal;
            var args;
            if (e == null || second == null &amp;&amp; typeof e === 'object') {
                e = e || {};
                e.sender = me;
                e._defaultPrevented = false;
                e.preventDefault = preventDefault;
                e.isDefaultPrevented = isDefaultPrevented;
                args = [e]
            } else {
                args = Array.prototype.slice.call(arguments, 1);
            }

            events = events.slice();
            for (var idx = 0, length = events.length; idx &lt; length; idx++) {
                var evt = events[idx];
                var context = evt.context || me;
                var rt = evt.callback.apply(context, args);
                if (rt !== undefined) {
                    retVal = rt;
                }
            }

            return retVal;
        },
        /**
         * Aspect 机制，在某个方法前执行
         * @description 如果返回 false，则会阻止正式方法的执行
         * @param {string} methodName - 方法名
         * @param {function} callback - 回调
         * @param {Object} [context] - 上下文
         * @returns {*}
         */
        before: function (methodName, callback, context) {
            return weaveAspect.call(this, 'before', methodName, callback, context);
        },
        /**
         * Aspect 机制，在某个方法后执行
         * @param {string} methodName - 方法名
         * @param {function} callback - 回调
         * @param {Object} [context] - 上下文
         * @returns {*}
         */
        after: function (methodName, callback, context) {
            return weaveAspect.call(this, 'after', methodName, callback, context);
        },
        _initProps: function () {
        },
        _call: function (func, args) {
            func.apply(this, Array.prototype.slice.call(args));
        }
    });

    return Observable;
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
